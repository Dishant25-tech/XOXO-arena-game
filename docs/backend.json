{
  "entities": {
    "UserSetting": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserSetting",
      "type": "object",
      "description": "Represents user-specific settings such as theme preferences.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user setting."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N UserSetting)"
        },
        "theme": {
          "type": "string",
          "description": "The user's preferred theme (e.g., light, dark)."
        }
      },
      "required": [
        "id",
        "userId",
        "theme"
      ]
    },
    "GameRecord": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GameRecord",
      "type": "object",
      "description": "Stores the historical record of a completed Tic Tac Toe game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game record."
        },
        "player1Id": {
          "type": "string",
          "description": "The user ID of player 1."
        },
        "player2Id": {
          "type": "string",
          "description": "The user ID of player 2. Can be 'computer' or another user's ID."
        },
        "winnerId": {
          "type": "string",
          "description": "The user ID of the winning player. Null for a draw."
        },
        "moves": {
          "type": "string",
          "description": "A serialized representation of the game moves."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the game was completed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "player1Id",
        "player2Id",
        "moves",
        "timestamp"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the XOXO Arena application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "username": {
          "type": "string",
          "description": "The user's username."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "username",
        "email"
      ]
    },
    "Game": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Game",
      "type": "object",
      "description": "Represents a live, real-time Tic Tac Toe game session between two players.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game session."
        },
        "player1Id": {
          "type": "string",
          "description": "The user ID of the player who created the game."
        },
        "player2Id": {
          "type": "string",
          "description": "The user ID of the player who joined the game. Null if waiting for an opponent."
        },
        "board": {
          "type": "string",
          "description": "A serialized representation of the 9-cell game board."
        },
        "nextPlayer": {
          "type": "string",
          "description": "The user ID of the player whose turn it is."
        },
        "status": {
          "type": "string",
          "description": "The current status of the game.",
          "enum": [
            "waiting",
            "active",
            "finished"
          ]
        },
        "winner": {
          "type": "string",
          "description": "The user ID of the winner, 'draw', or null if the game is ongoing."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp for when the game was created."
        }
      },
      "required": [
        "id",
        "player1Id",
        "board",
        "nextPlayer",
        "status",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. The 'userId' is the Firebase Authentication UID.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/settings/{settingId}",
        "definition": {
          "entityName": "UserSetting",
          "schema": {
            "$ref": "#/backend/entities/UserSetting"
          },
          "description": "Stores user-specific settings. The `userId` ensures only the user can access their own settings.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID of the user."
            },
            {
              "name": "settingId",
              "description": "Unique ID for the user setting."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/game_records/{gameRecordId}",
        "definition": {
          "entityName": "GameRecord",
          "schema": {
            "$ref": "#/backend/entities/GameRecord"
          },
          "description": "Stores records of games played by the user. Uses path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID of the user who played the game."
            },
            {
              "name": "gameRecordId",
              "description": "Unique ID for the game record."
            }
          ]
        }
      },
      {
        "path": "/games/{gameId}",
        "definition": {
          "entityName": "Game",
          "schema": {
            "$ref": "#/backend/entities/Game"
          },
          "description": "Stores live game sessions. This collection is publicly readable for game discovery but write access is restricted.",
          "params": [
            {
              "name": "gameId",
              "description": "Unique ID for the live game session."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the XOXO Arena application with a focus on user settings, game records, and live multiplayer games. The structure leverages path-based ownership for user-specific data like settings and game records. This approach ensures that security rules can be written to easily control access based on the currently logged-in user, achieving Authorization Independence. A new top-level `games` collection is introduced for live multiplayer sessions. This allows any authenticated user to find and join a waiting game, while write access is controlled to ensure only the current players can modify the game state. Denormalization is used where necessary to avoid `get()` calls in the rules.\n\n*   `/users/{userId}/settings/{settingId}`: Stores user-specific settings. The `userId` in the path ensures that only the user can access their own settings.\n*   `/users/{userId}/game_records/{gameRecordId}`: Stores the records of games played by a specific user. This organization enables efficient retrieval of a user's game history.\n*   `/games/{gameId}`: Stores live game sessions. This is a crucial addition for multiplayer functionality. Keeping it at the root level allows for easier querying to find open games. Security rules will ensure that only involved players can make moves.\n\nThis structure supports the required QAPs by:\n\n*   **Secure List Operations:** Path-based ownership (`/users/{userId}/...`) allows listing operations that are inherently secure. The `/games` collection is listable by any authenticated user to find a match, which is a required feature.\n*   **Authorization Independence:** By embedding the user ID in user-specific paths, we avoid fetching parent documents for authorization. For the `/games` collection, authorization logic will rely on the `player1Id` and `player2Id` fields within the document itself, which is necessary for the multiplayer context."
  }
}
